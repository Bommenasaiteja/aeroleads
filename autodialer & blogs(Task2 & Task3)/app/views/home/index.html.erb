<div class="container">
  <div class="row">
    <div class="col-md-8">
      <div class="flex items-center mb-4">
        <div>
          <h1 class="mb-1 font-semibold" style="color: var(--foreground);">Autodialer Dashboard</h1>
          <p class="text-muted mb-0">AI-Powered Call Management System</p>
        </div>
      </div>
    
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-value"><%= @total_numbers %></span>
          <span class="stat-label">Total Numbers</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" style="color: #ed8936;"><%= @pending_calls %></span>
          <span class="stat-label">Pending Calls</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" style="color: #48bb78;"><%= @completed_calls %></span>
          <span class="stat-label">Successful Calls</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" style="color: #f56565;"><%= @failed_calls %></span>
          <span class="stat-label">Failed Calls</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card mb-4">
        <div class="card-header">
          <div class="flex items-center">
            <h5 class="mb-0 font-medium">Quick Actions</h5>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-6">
            <div class="col-md-6">
              <%= form_with url: call_all_phone_numbers_path, method: :post, local: true do |f| %>
                <%= f.submit "Call All Pending (#{@pending_calls})", 
                    class: "btn btn-primary w-full", 
                    confirm: "This will call all pending numbers. Continue?" %>
              <% end %>
            </div>
            <div class="col-md-6 mt-10">
              <%= link_to upload_phone_numbers_path, 
                  class: "btn btn-outline w-full flex items-center justify-center gap-2" do %>
                <i class="bi bi-cloud-upload"></i>
                Upload Numbers
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Call Activity -->
      <div class="card">
        <div class="card-header">
          <div class="flex justify-between items-center">
            <h5 class="mb-0 font-medium">Recent Call Activity</h5>
          </div>
        </div>
        <div class="card-body">
          <% if @recent_calls.any? %>
            <% @recent_calls.each_with_index do |call_log, index| %>
              <div class="flex justify-between items-start py-3" style="<%= 'border-bottom: 1px solid var(--border);' unless index == @recent_calls.length - 1 %>">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <i class="bi bi-telephone text-sm"></i>
                    <span class="font-medium"><%= call_log.phone_number.number %></span>
                  </div>
                  <div class="flex items-center text-muted text-sm">
                    <i class="bi bi-clock me-1"></i>
                    <%= time_ago_in_words(call_log.created_at) %> ago
                    <% if call_log.duration > 0 %>
                      <span class="mx-2">•</span>
                      <%= call_log.duration %>s
                    <% end %>
                  </div>
                </div>
                <div>
                  <% if call_log.successful? %>
                    <span class="badge badge-success"><%= call_log.status.humanize %></span>
                  <% elsif call_log.failed? %>
                    <span class="badge badge-danger"><%= call_log.status.humanize %></span>
                  <% else %>
                    <span class="badge badge-warning"><%= call_log.status.humanize %></span>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <div class="mt-4 text-center">
              <%= link_to phone_numbers_path, class: "btn btn-outline flex items-center gap-2" do %>
                <i class="bi bi-list-ul"></i>
                View All Phone Numbers
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-telephone-x text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
              <h6 class="text-muted mb-2">No recent call activity</h6>
              <p class="text-muted mb-3">Start by uploading phone numbers to begin calling!</p>
              <%= link_to upload_phone_numbers_path, class: "btn btn-primary btn-sm" do %>
                <i class="bi bi-cloud-upload me-2"></i>
                Upload Numbers Now
              <% end %>
            </div>
          <% end %>
      </div>
    </div>
  </div>

    <!-- AI Chat Sidebar -->
    <div class="col-md-4">
      <div class="card chat-container">
        <div class="card-header" style="background: var(--primary); color: var(--primary-foreground);">
          <div class="flex items-center">
            <i class="bi bi-robot me-2"></i>
            <div>
              <h5 class="mb-0 font-medium">AI Assistant</h5>
              <small style="opacity: 0.9;">Powered by OpenAI</small>
            </div>
          </div>
        </div>
        <div class="chat-messages" id="ai-chat-messages">
          <div class="chat-message ai">
            <strong>AI Assistant</strong>
            <div class="mt-2">
              Hi! I can help you manage your autodialer. Try commands like:
              <div class="mt-3 text-sm">
                <div class="flex items-center mb-2">
                  <i class="bi bi-telephone me-2"></i>
                  <span>"Call 1800-123-4567"</span>
                </div>
                <div class="flex items-center mb-2">
                  <i class="bi bi-broadcast me-2"></i>
                  <span>"Call all numbers"</span>
                </div>
                <div class="flex items-center mb-2">
                  <i class="bi bi-graph-up me-2"></i>
                  <span>"Show me the stats"</span>
                </div>
                <div class="flex items-center">
                  <i class="bi bi-list-ul me-2"></i>
                  <span>"List all numbers"</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="chat-input">
          <%= form_with url: ai_chat_process_path, method: :post, local: false, id: "ai-chat-form" do |f| %>
            <div class="input-group">
              <%= f.text_field :message, 
                  placeholder: "Type your command here...", 
                  class: "form-control", 
                  id: "ai-message-input" %>
              <%= f.submit "Send", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

      <!-- Blog Section -->
      <div class="card mt-4">
        <div class="card-header">
          <div class="flex justify-between items-center">
            <h6 class="mb-0 font-medium">Latest Blog Posts</h6>
          </div>
        </div>
        <div class="card-body">
          <% blog_posts = BlogPost.published.limit(3) %>
          <% if blog_posts.any? %>
            <% blog_posts.each_with_index do |post, index| %>
              <div class="mb-3 pb-3 <%= 'border-bottom' unless index == blog_posts.length - 1 %>">
                <div class="flex items-start">
                  <div class="flex-1">
                    <%= link_to post.title, blog_post_path(post), 
                        class: "text-decoration-none font-medium block mb-1 text-sm" %>
                    <div class="flex items-center">
                      <small class="text-muted">by <%= post.author %></small>
                      <% if post.author == "AI Assistant" %>
                        <span class="badge badge-secondary ms-2 text-xs">AI</span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
            <%= link_to blog_posts_path, class: "btn btn-outline w-full mt-2" do %>
              View All Posts
            <% end %>
          <% else %>
            <div class="text-center py-3">
              <i class="bi bi-journal-plus text-muted mb-2 d-block" style="font-size: 2rem; opacity: 0.5;"></i>
              <p class="text-muted mb-3 text-sm">No blog posts yet</p>
              <%= link_to new_blog_post_path, class: "btn btn-primary btn-sm" do %>
                <i class="bi bi-magic me-1"></i>
                Create AI Posts
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const aiChatForm = document.getElementById('ai-chat-form');
  const messageInput = document.getElementById('ai-message-input');
  const chatContainer = document.getElementById('ai-chat-messages');
  const sendButton = aiChatForm.querySelector('input[type="submit"]');
  
  // Auto-resize textarea
  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });
  
  // Handle Enter key
  messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      aiChatForm.dispatchEvent(new Event('submit'));
    }
  });
  
  aiChatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Add loading state to button
    sendButton.classList.add('btn-loading');
    sendButton.disabled = true;
    messageInput.disabled = true;
    
    // Add user message with animation
    const userMessage = document.createElement('div');
    userMessage.className = 'chat-message user';
    userMessage.style.opacity = '0';
    userMessage.style.transform = 'translateY(20px)';
    userMessage.innerHTML = `<strong>You</strong><div class="mt-1">${message}</div>`;
    chatContainer.appendChild(userMessage);
    
    // Animate user message
    setTimeout(() => {
      userMessage.style.transition = 'all 0.3s ease';
      userMessage.style.opacity = '1';
      userMessage.style.transform = 'translateY(0)';
    }, 10);
    
    // Add typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'typing-indicator';
    typingIndicator.innerHTML = `
      <strong class="me-2">AI Assistant</strong>
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    `;
    chatContainer.appendChild(typingIndicator);
    
    // Clear input and scroll
    messageInput.value = '';
    messageInput.style.height = 'auto';
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Send to server
    fetch('<%= ai_chat_process_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: `message=${encodeURIComponent(message)}`
    })
    .then(response => response.json())
    .then(data => {
      // Remove typing indicator
      typingIndicator.remove();
      
      // Add AI response with animation
      const aiMessage = document.createElement('div');
      aiMessage.className = 'chat-message ai';
      aiMessage.style.opacity = '0';
      aiMessage.style.transform = 'translateY(20px)';
      
      // Format message with icons for actions
      let formattedMessage = data.message.replace(/\n/g, '<br>');
      
      // Add success icon for successful actions
      if (data.success && (formattedMessage.includes('✅') || formattedMessage.includes('Call initiated'))) {
        aiMessage.classList.add('success-animation');
      }
      
      aiMessage.innerHTML = `<strong>AI Assistant</strong><div class="mt-1">${formattedMessage}</div>`;
      chatContainer.appendChild(aiMessage);
      
      // Animate AI message
      setTimeout(() => {
        aiMessage.style.transition = 'all 0.3s ease';
        aiMessage.style.opacity = '1';
        aiMessage.style.transform = 'translateY(0)';
      }, 300);
      
      // Scroll to bottom
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      // Handle redirect action
      if (data.action === 'redirect' && data.url) {
        setTimeout(() => {
          window.location.href = data.url;
        }, 2000);
      }
    })
    .catch(error => {
      // Remove typing indicator
      typingIndicator.remove();
      
      const errorMessage = document.createElement('div');
      errorMessage.className = 'chat-message ai';
      errorMessage.innerHTML = `
        <strong>AI Assistant</strong>
        <div class="mt-1">
          <i class="bi bi-exclamation-triangle text-warning me-1"></i>
          Sorry, I encountered an error. Please try again.
        </div>
      `;
      chatContainer.appendChild(errorMessage);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    })
    .finally(() => {
      // Remove loading state
      sendButton.classList.remove('btn-loading');
      sendButton.disabled = false;
      messageInput.disabled = false;
      messageInput.focus();
    });
  });
  
  // Add smooth scrolling to all anchor links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      document.querySelector(this.getAttribute('href')).scrollIntoView({
        behavior: 'smooth'
      });
    });
  });
  
  // Add loading states to forms
  document.querySelectorAll('form[method="post"]').forEach(form => {
    form.addEventListener('submit', function() {
      const submitBtn = this.querySelector('input[type="submit"], button[type="submit"]');
      if (submitBtn && !submitBtn.classList.contains('btn-loading')) {
        submitBtn.classList.add('btn-loading');
        submitBtn.disabled = true;
      }
    });
  });
});
</script>
